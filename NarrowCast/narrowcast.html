<!DOCTYPE html>
<html>

  <head>

    <meta charset="UTF-8">
    <meta name="author" content="Maarten Pennings">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NarrowCast</title>
    
    <style>
      body {
        margin: 0pt;
        background-color: black;
        color: rgb(212,214,216); 
        font-family: 'Lato', sans-serif;
        height: 100vh;
        overflow: hidden; /* suppresses scroll bar for @keyframes fly_from_right */
      }
      
      #fmt_main {
        height: 95%; /* #fmt_bar height must complement to 100 */
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #fmt_main > div {
        display: inline-block; /* is access in javascript */
        position: absolute;
        background-color: black;
        border: 3px solid rgb(212,214,216); 
        border-radius: 20px; 
      }
      #fmt_logo {
        position: absolute;
        top: 0px;
        right: 0px;
      }
      #fld_title {
        font-size: 5.5vh;  
        padding: 0.2em;
        top: 2vh; left: 2vw; /* Overridden by @keyframes fly_from_left at 100% */
        text-align: left;
        max-width:60%;
        animation-name: fly_from_left;
        animation-duration: 0.9s;
      }
      #fld_img {
        max-height: 100%;
        max-width: 100%;
      }
      #fld_description {
        font-size: 3vh;  
        padding: 0.5em;
        bottom: 8vh; right: 2vw; /* Overridden by @keyframes fly_from_right at 100% */
        text-align: right;
        max-width:50%;
        animation-name: fly_from_right;
        animation-duration: 0.9s;
      }

      @keyframes fly_from_left {
        0%   {top:2vh; left:-60vw; } /* Left matches max-width in #fld_title */
        100% {top:2vh; left:2vw; }
      }
      @keyframes fly_from_right {
        0%   {bottom:8vh; right:-50vw; } /* Left matches max-width in #fld_title */
        100% {bottom:8vh; right:2vw; }
      }
      
      #fmt_bar {
        background-color: black;
        height: 5%;  /* #fmt_main height must complement to 100 */
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }
      #fmt_bar > * {
        display: inline-block;
        height: 100%;
        font-size: 2vh;  /* #fmt_bar height must roughly double */
        /* border: 1px solid rgb(70,85,95); */
        box-sizing: border-box; 
        padding-top:1vh;
      }
      #fld_pagecursor {
        text-align: center;
        width: 5vw; /* all #fmt_bar children must add to (max) 100vw */
      }
      #fld_source {
        text-align: left;
        padding-left: 6px;
        width: 15vw; /* all #fmt_bar children must add to (max) 100vw */
      }
      #fmt_pageshow {
        text-align: center;
        padding-left: 16px;
        padding-right: 16px;
        width: 60vw; /* all #fmt_bar children must add to (max) 100vw */
      }
      #fmt_pageshow_bg {
        background-color:rgb(70,85,95);
        border-radius:2vh; /* must be the same as for #fld_pageshow */
        text-align:left;
      }
      #fld_pageshow {
        display:inline-block;
        border-radius:2vh; /* must be the same as for #fmt_pageshow_bg */
        background-color:rgb(0,117,176); 
        width:0%
      }
      #fld_datetime {
        text-align: right;
        padding-right: 6px;
        width: 15vw; /* all #fmt_bar children must add to (max) 100vw */
      }
      #fld_xmlload {
        text-align: center;
        width: 5vw; /* all #fmt_bar children must add to (max) 100vw */
      }
    </style>

    <script> 
      // Some diversity constants
      var div_error_png= 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAgCSURBVFhHjZdJbJxVEsc/2+0l3mInR+CAhDQZJC5o5oQ4wlw4gMQNiRsSSZyE5YCE0MwhSDMXDgg0jASjMCFggpzESxzStuN4C17aW7fteGvasbEdYuMl3u0krvn9X/czHYJH80l/v/req1f/qnr16msH29vbtr6+bisrKyZ5bW3NVldX92RBsua8LF3tuW9mq7xvbGzY1taW3b171zY3Nx0ka26/ee2RnUCGZUyLkrUg/C9568ED24F8vK7OppuabAt54949Z8M7LVl2ve30eY1+PvAvMi55P1Ivb+zu2i+zs9YaBDYBboEWMBuPO6dky9vxDkhOJ03nfOgIdnZ23KKXRSxIdmkndSugHcIVsChkBLbK2AnmFxZsi0woxcvLy3tH4GWRSxanyHUcgf7oRZNalNJ+Bh4QYduRI458LivLxg8etLGSEpvJybZ15lqfeMLuobNfAF4Wp4IWZyBCvWjRp0fw84LkDc490dLq0r4M4hBPlpbaJKOcWMzMtGnNh8O2jRPeniBZQQp+3nMGmtSLSH9PFiQrsrZDh2wNkpncPJsQeQoJMpHIz7cd1toLC9zt8DaE/WxL3jsCpdjL8lCyRs2v3b9v8Zpqm4VgNSPDRoqLbCKVgVuMEzgwXFhki1mZtoBO7MwZd1wiEJRqRetlV0844I5Af/QiQn9uD50hm/TcIMXbGJ/MybXRwkJLFBRYIi/PfhQOHLBR3odzc20XnQjQri1sp9eQAnqkCEUiB/Y7K12t/n9+5ip+lYrvh2wEorHHH7fx55+38eees7Gnn7aR7GzrZ36B4tQxDX78sesPilp2fDbkSDrnI31AsiB5AwUZ6cLgAzAeyrYYJDeRJ994g5Xks1BdbYPMDXAb+nDEkHuAa1DYkG1vN51HciCP9KK0KzValIeSZSD293+4K7bGEXSS/sG8A44s/sorjlzP7c/+ZQNygOKMoHOHLMjhyHvvuYL09SRCyeKULM59+8BdFuWAIlFEg0TfKwc4gqFMesCLf3HkemY/+iiZAdZ0DB0uCxlubpn1e1zh/6sPiNhnQFXcUXbC7mNklehvZOdaFOODXLebEIxy/v6ZOf2hDaE3RCFGKcoOdKfJgjuKN9+0TXR8BuRIOmcgwUMKbsSRFTYpAmckFLLunDyLEuEgN2CUcfxPf3bkembef99GcHKoqMjpKFOtZExZGGH/klJOtOlcHoE8kuDSnjoOnVvna6858iXS3aT0c76x/AK7WVxscYjizzyTZOeZeftti5OdYfrBQEGh9VEnbdk5lkhloePll113VHaV9nTOR/qAPjjz1MK4os/ItB+yQtZOynswOlBUbCM0noTw1FNJdp5Z0qxOOFJaYoPo9OXlWycONJA52VD7np+fty0a2iN9IN0byYr+hxdecJ7PEb2MqKi6MRqj242WHrKJw4ct8dhjSXaemddft1tkZezQYRssPmg9ZKozJ4fMhWwolYVOakY9RTw6+70MSPDQj4o709M2lYq+AQeaMdJOUUXIQLSQDECSwIE4bdg/06++agkiH2UthgPdZKODDLSxtwYbu9SH2vhPw8O2SRbSOR/qA3ran33WeTzFpsvOgSxuQI514UAfBThUUmpxHBhmzj+TL73k6uIm2elnjFCI2tOcHbKr2IikstD+hyPuaqdz7vUBfe3ikYj9nIq+EgfC4BqbWzDUTpF1k9ooRThMpMM4NPfJJ3aHljt+5I82crDEYhRhD1exg4Jt4dgacb4eGxVgLTPDbmN7Go411RoOuD7gvVGVdj35pPNUV6oiI8vCkNdThNdJZStXqx3SHqo8CtkgzqhJCQM4HGOulxrpPJBvbTh7HQe0tw5Uk4VGbKo7tpE9PeupnuBqQGn5sbHRllAwlM+hXMlYyxjOTBpqxGArkbVD0EV6e4naP2NHj7nvRQdn34bOddbrQznsDdkV7NRkhKwcJ3/Cnupr9NIlxynuYIWKdPee9Cn6HjZ8zTf/Eso1ZOEKWQhn4QS9oBGjzWSiGb3bFRccuZ4divcacy2QN6bI63Bce2WjCgcu8FuhCif0e6GZG+JvRCDygfJy22BB0X/OhvMoXkSuRJaBWgxdJZp6HGnAeD26o3/9myPXsxSLWZi5az5yMlYLkuRZdhHyC9j7CrtRoK9p/OxZW+MbEahP9+lKMdlK1F+y4VsKRjVwMXUUVaAGBy5j9HucCJONGvSHPvjA4p9+6tIcRv975q+gJ13t0V6RVzAqqG+wex49NbkGsqwnWKI9xpkwFs+gdA7lcuRvUajgXZ7rOC4xVuFAVYqgFlSzT6gNuLI4liQOOWLt0V4FIluy+Q1z/8amjrmJfUtzcxb8MjVlCV62WfiOhS8Y/8Mmpesc+NoBh9h8HnwHFNEFjuViGvSueV056SjicvZp/1e8n2X8Esi+d2CWowv0261D3oA5FJtYbGB0QNkBuZ75JLz861gHwshXdQyMV3jXDboMqgXm/ZHcAN1krBa+XR2BinCcn1T6b0dXRL/thUmgf7uUHR3RGBgFw0Dffn2qYyAK+kEvUE/oBvpRKuhq/hYKVuRTlZW2zr957jehmtDC4qINnD5tvXxae06dsug771j3iTLrLiuz/rfessixY9Z9/Jj1sxY5etR6jh93chdfwt4y5JMnk/KJE9aHLJ2+UyeT+qxH333XoY/CXeFfOHGqA+/9KNX/dLoRup+CZLVnwcvp815WBmVMjeX3ZEGy5iRrrz754tzc3LT/AuKPYZQMg98hAAAAAElFTkSuQmCC'
      var div_wait_png= 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAiCAYAAAA6RwvCAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAARwSURBVFhHzZfLSl1LEIZb3QdMEE8Qn8AnEAQHXkDBG97QkYo+gEPfQx/ABxBx5m3mQFQ0QcUr4mWiU2ME48BEvO30/+/9d2p1ljvhJHDyQdlV1VXVtXr3avcuynrcX0Ax/jw/P1NeXl6CDhobG11RUdEfEdQCdg2I9oE7Yh0ik8m4jY0Nd3Nz48rLy+lDwSRZn2f9se093nF7e+sqKipcfX29e3p6ys/kQGxJSQkD0Uj28fExiA/mCObn59HhbwlqALuG1oEA7gi2CwLQoXdRx67Mzc25/v5+t7297a6vr8Mc0JPLF+9EZWWlq62tdbOzs66vry/shs1L7Ih2QB2qY+CL8Kn+K8j1D0Pd7oTVAQ+r8DbFYm2cJZ8YRklsyydsDbvjQLuTaMRurdUFt9CTVjjOVSyw8a81xUZURE4boLNzeXnp/KHjuYFgIRuHET7N4Wx9/HgZ5mJsLvEG35qHh4fwmUGgg/X1dURTx5jJlGQnJiZopzE+Pp71jSRy/DVA3a6hM6J1EvdIvDN6asjS0pI7Pz93o6OjnAM1NTVueHiY81NTU25nZyc/49zk5KSrqqpybW1trGfXUH1QXFxMgTN0GHeqbru6usITjoyMUC8kvjnGQu/p6aH+Wn18GoDVYcQBSIIIFG1vb6c+NjaWWNgK5gBiYYu0JrQOKNiIdLC/v8/Cg4ODtKenpxMNQPzHw7mBgQHah4eHtPVQtj5EfhAawUFScJyk4NXVVS7Q2tpK++zsLDRxenpKX0tLC+21tTXaWszWU03pgI2kBUo0hxEcHx9zoebmZtoHBwfcLdDU1MS5k5MT2jY3rSYePnFGfpZgBfi3hwtubW3RBpubm/RdXFzQtrl6bSG2CYxqJNys8WtlbYywhU/maOOFLsC0XFtTvlDDK6mH1YqeAhwdHSGTHwNQDMDHhTl8fMDmpu2u/CA0Et96NlHBy8vLXAgHEiDPxgMcZMSsrKzQht/WUqzVARvRRJxgA3d3d7nA0NAQbTQBEdZGDGJ1iON6sQ0KNqIggML+uqZu/b29vRSBPNDR0cEc4M9NqBevoeYTjVhRErBXvNBbYgU+C3zd3d3U09bQOoDV0VU8CQnd+oIzMzPUQWdnZ6IBK5gTyIEPoJZtRvqrjagJ6AD/wlXsy5eviUX9K5gYrdzf3zMHOr5KALuGHQHvET8m7gnYAl+IxNu3b/Ia7oHveXE+KC0tzWvOXV1d5bXv9wdAHr8CeMKFZosCJWj0bwBHkIvTmIvP5XM25Pjrn2NcSzlAOhspFCDyIURzcUzO5MdNO43X5sKOWNCYmhOZzD957dfB91eQ1ni8xg8/sAACkGR/YO3t7bm7u7t8MorkYlXcFoUPUlZW5qqrq3/4gQW0BkZ8JYURTq89yTrNCwsLWOm3ZHFxkbXit0XfgUDBH+EfPrx3nz5du3fv/vWe5FYqXj6bn/Rl3efPt/z5WVdXF3YFc4hLfHnGFYzObMfA/3rPVfoD0tDQwJpaB3eXLjnAHfGB/zPOfQNXxFa47OwDXwAAAABJRU5ErkJggg==';
      var div_timeinterval_xmlload= 15*60; //How many seconds before reloading the page list
      var div_timeinterval_pageshow= 20; // How many seconds before showing next page

      // The core diversity: list of channels
      var server= 'https://maarten-pennings.github.io/NarrowCast/'
      var div_list= [server+'weather.channel',server+'art.channel'];
    
      // Generic libraries ========================================
      
      function array_shuffle(array) { // Return shuffled copy of `array`
        var currentIndex = array.length, temporaryValue, randomIndex;
        while( 0!==currentIndex ) {
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
        return array;
      }    
      
      // Load a list of XML files into an array ================================

      var xml_stilltoload; 
      var xml_callback;
      var xml_pages;
      function xml_adderror(url,msg) {
        var opage= { source:url, img:div_error_png, title:'Error', description:msg };
        xml_pages.push(opage)
        console.warn('Error loading '+url+' '+msg);
      }
      function xml_addfromfile(url,sxml) {
        var oparser= new DOMParser();
        var odom= oparser.parseFromString(sxml,'text/xml');
        var orss= odom.querySelector('rss');
        if( orss==null ) { xml_adderror(url,'root "rss" missing'); return; }
        var ochannel= orss.querySelector('channel');
        if( ochannel==null ) { xml_adderror(url,'tag "channel" missing'); return; }
        var osource=ochannel.querySelector('title');
        if( osource==null ) { xml_adderror(url,'tag "channel" has no "title"'); return; }
        var oitems= odom.querySelectorAll('item');
        if( oitems==null || oitems.length==0) { xml_adderror(url,'tag "channel" has no "item"'); return; }
        for( var i=0; i<oitems.length; i++ ) {
          var oenclosure= oitems[i].querySelector('enclosure');
          if( oenclosure==null ) { xml_adderror(url,'"item" '+(i+1)+' has no "enclosure" (for image)'); continue; }
          var simg= oenclosure.getAttribute('url')
          if( simg==null ) { xml_adderror(url,'"item" '+(i+1)+' has an "enclosure" but no "url" (for image)'); continue; }
          if( simg=="" ) { xml_adderror(url,'"item" '+(i+1)+' has an "enclosure" with an empty "url" (for image)'); continue; }
          if( simg.indexOf(':')==-1 ) { // image url has no ':', so is not absolute, prepend url of xml
            simg= url.substring(0,url.lastIndexOf('/')+1)+simg;
          }
          var otitle= oitems[i].querySelector('title');
          if( otitle==null ) { xml_adderror(url,'"item" '+(i+1)+' has no "title"'); continue; }
          var odescription= oitems[i].querySelector('description');
          if( odescription==null ) { xml_adderror(url,'"item" '+(i+1)+' has no "description"'); continue; }
          var opage= { source:osource.textContent, img:simg, title:otitle.textContent, description:odescription.textContent };
          xml_pages.push(opage)
        }
        console.log('Loaded '+oitems.length+' pages from '+url);
      }
      function xml_handler() {
        // console.log('xml_handler '+this.readyState+' '+this.status+' '+this.tag);
        if( this.readyState==4 ) {
          // xml request ready (successfully or with error)
          if( this.status==200 ) xml_addfromfile(this.tag,this.responseText); else xml_adderror(this.tag,'Failed loading');
          if( --xml_stilltoload == 0 ) { // All urls loaded, callback
            xml_pages= array_shuffle(xml_pages);
            xml_callback(xml_pages);
          }
        }
      }
      function xml_request(url) { 
        // console.log('xml_request '+url);
        var oreq= new XMLHttpRequest();
        oreq.tag= url; // Tag added for debugging
        oreq.onreadystatechange= xml_handler;
        oreq.open('GET',url);
        oreq.send();
      }
      function xml_loader(urls,callback) {
        // console.log('xml_loader');
        xml_stilltoload= urls.length; // When 0, callback will be called
        xml_callback= callback; // Function to call when all urls loaded
        xml_pages= []; // List of all pages of all xml files
        for( var ix in urls ) {
          xml_request(urls[ix]);
        }
      }
      
      // Main =================================================
      
      var main_timestart_xmlload; // Records when xml was loaded (in main_xmlload), so that status bar can show time-to-go
      var main_timestart_pageshow; // Records when page was shown (in main_showpage), so that status bar can show time-to-go
      var main_pages;
      function main_showtime() {
        var now= new Date;
        var reload_remain_s= Math.round( (now - main_timestart_xmlload) / 1000 );
        var page_remain_ms= now - main_timestart_pageshow;
        // Build strings
        var perc= (100/1000)*page_remain_ms/div_timeinterval_pageshow; if( perc>100 ) perc=100;
        document.getElementById('fld_pageshow').style.width= perc+"%";
        document.getElementById('fld_xmlload').innerHTML= main_timestart_xmlload==null? '-' : div_timeinterval_xmlload-reload_remain_s;
        document.getElementById('fld_datetime').innerHTML= now.getHours() + (now.getMinutes()<10?':0':':') + now.getMinutes() + ' ' +
          ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][now.getDay()] + ' ' +
          ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][now.getMonth()] + ' '+
          now.getDate(); // + ' ' + now.getFullYear();
      }
      function main_animate(elm) { // recreate elm, this retriggers the animation
        var newone = elm.cloneNode(true);
        elm.parentNode.replaceChild(newone, elm);        
      }
      var main_imgcache= new Image();
      function main_showpage() {
        main_timestart_pageshow= Date.now(); // Timestamp page show, so that we can show remaining page time in bar
        // Advance to next page (with wrap around)
        main_pages.cursor= (main_pages.cursor+1) % main_pages.length;
        var page= main_pages[main_pages.cursor];
        // Display page
        document.getElementById('fld_title').innerHTML= page.title;
        document.getElementById('fld_title').style.display= page.title==""? "none" : "inline-block";
        document.getElementById('fld_img').src= page.img;
        document.getElementById('fld_description').innerHTML= page.description;
        document.getElementById('fld_description').style.display= page.description==""? "none" : "inline-block";
        document.getElementById('fld_source').innerHTML= page.source;
        document.getElementById('fld_pagecursor').innerHTML= (main_pages.cursor+1)+'/'+(main_pages.length);
        // Trigger animation
        main_animate( document.getElementById('fld_title') );
        main_animate( document.getElementById('fld_description') );
        // Preload next image
        main_imgcache.src= main_pages[ (main_pages.cursor+1) % main_pages.length ].img;
      }
      var main_pagetimer;
      function main_startpage() { 
        if( main_pagetimer!=null ) clearInterval(main_pagetimer); // If there is a page timer running, stop it
        main_showpage(); main_pagetimer=setInterval(main_showpage, div_timeinterval_pageshow*1000); 
      }
      function main_loadhandler(pages) { // Handler is called when xmlload finishes
        //for( var page of pages ) console.log(page); 
        console.log('New playlist '+pages.length+' pages');
        main_pages= pages;
        main_pages.cursor= -1; // Cursor added (which page to show)
        main_startpage();
      }
      function main_xmlload() {
        main_timestart_xmlload= Date.now(); // Timestamp start page list load, so that we can show next load in bar
        xml_loader(div_list, main_loadhandler); // Handler is called when xmlload finishes
      }
      function main() {
        document.getElementById('fmt_pageshow').onclick= main_startpage;
        document.getElementById('fld_img').src= div_wait_png; // Wait-image during first page list load (during next page list loads, previous page list is played)
        main_showtime(); setInterval(main_showtime, 50 ); // Timer to update the bottom bar (page, date/time)
        main_xmlload(); setInterval(main_xmlload, div_timeinterval_xmlload*1000 ); // Timer to reload xml page list
      }
      // Start loading and playing pages, once html is loaded
      window.onload= main; 
    </script>
  </head>

  <body>
    <div id="fmt_main">
      <img id='fmt_logo' src='logo.png'>
      <div id='fld_title'>Waiting for data to load...</div>
      <img id='fld_img' >
      <div id='fld_description'>Waiting for data to load...</div> 
    </div>
    <div id="fmt_bar">
      <div id='fld_pagecursor'>wait</div>
      <div id='fld_source'>wait</div>
      <div id='fmt_pageshow'><div id='fmt_pageshow_bg'><div id='fld_pageshow'>&nbsp;</div></div></div>
      <div id='fld_xmlload'>wait</div>
      <div id='fld_datetime'>wait</div>
    </div>
  </body>

</html>

<!--
TODO
 - add .list file, which enumerates .channel
 
 - nu.nl
 - traffic information
 - airport departures/arrivals
 
 - cgi with https://wkhtmltopdf.org/
-->
